---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# G4Micro

<!-- badges: start -->
[![R-CMD-check](https://github.com/CarlosMoraMartinez/G4Micro/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/CarlosMoraMartinez/G4Micro/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

G4Micro contains helper functions used to analyze microbiome data in the Mora-Martinez, Molina-Mendoza et al. paper. 

## Installation

You can install the development version of G4Micro from [GitHub](https://github.com/) with:

``` r
# install.packages("pak")
pak::pak("CarlosMoraMartinez/G4Micro")
```

## Alpha Diversity Analysis

Load a list of phyloseq objects and select one of them.

```{r load, warning=FALSE, message=FALSE}
library(G4Micro)

data("all_phyloseq")
phobj <- all_phyloseq$remove_tanda2_rarefied_min
phobj
```

A list with default options is also loaded:

```{r load2}
opt <- opt_default
print(opt)
```

Calculate alpha diversity indices

```{r alpha1, warning=FALSE, message=FALSE}
opt$out <- "~/"
outdir <- paste0(opt$out, "/AlphaDiversity/")
if(!dir.exists(outdir)) dir.create(outdir)

alpha_indices <-  c("Observed", "Chao1", "Shannon", "InvSimpson")

divtab <- calculateAlphaDiversityTable(phseq_obj = phobj, outdir = outdir, 
                                       indices = alpha_indices, name = "AlphaDiv" )

divtab %>% select(sampleID, Condition, all_of(alpha_indices)) %>% 
  head %>% kableExtra::kable()
```

Test statistical differences between alpha diversity indices:

```{r alpha2, warning=FALSE, message=FALSE}

alphadif <- testDiversityDifferences(divtab, alpha_indices, 
                                     groupvars = c("Condition", "Sexo"), 
                                     outdir = outdir, name = "AlphaDiv_test")

alphadif %>% kableExtra::kable()
```

Fit linear models using a main variable and several covariates:

```{r alpha3, warning=FALSE, warning=FALSE, message=FALSE}
interestvar <- "Condition"
extravars <- c("BMI", "bristol_scale", "Sexo")

models <- makeLinearModelsSingleVariable(divtab, interestvar,
                                            extravars,
                                            alpha_indices,
                                            combos=1,
                                            outdir = outdir, 
                                            name = "linmodels1")
```

Now show tests for single variables:

```{r alpha4}
models$single_anovas %>% select(-mod1, -mod2, nvars, Index, 
                                model, reduced_model, Df, 
                                `Pr(>F)`, padj_all) %>% 
  kableExtra::kable()
```

Finally, plot differences (recalculating statistical tests):


```{r alpha6, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
library(cowplot)

cat_vars <- c("Condition", "Sexo")
num_vars <- c("BMI", "bristol_scale")

divplots <- getAlphaDiversity(phobj, 
                              vars = cat_vars, 
                              qvars = num_vars,
                              opt,
                              indices = alpha_indices,
                              correct_pvalues = T, correct_pvalues_indices = T,
                              name = "alphaplots1", w = 10, h = 4)

cowplot::plot_grid(plotlist = divplots, nrow = 4)
```

## Beta Diversity Analysis

PCoA on Bray-Curtis distances:

```{r beta1, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
library(cowplot)

vars <- c("Condition", "Sexo", "BMI")
betaplots <- makeAllPCoAs(phobj, outdir,
                          method = "PCoA",
                          name = "PCoA_Bray",
                          dist_type = "bray",
                          dist_name = "Bray-Curtis",
                          vars2plot = vars,
                          extradims = 2:3,
                          labelsamples = "sampleID",
                          create_pdfs = T)

cowplot::plot_grid(plotlist = betaplots, nrow = 3)
```

NMDS on Bray-Curtis distances:


```{r beta2, fig.width=12, fig.height=6, warning=FALSE, message=FALSE}
library(cowplot)

vars <- c("Condition", "Sexo")
betaplots <- makeAllPCoAs(phobj, outdir,
                          method = "NMDS",
                          name = "NMDS_Bray",
                          dist_type = "bray",
                          dist_name = "Bray-Curtis",
                          vars2plot = vars,
                          extradims = 2,
                          labelsamples = "sampleID",
                          create_pdfs = T)

cowplot::plot_grid(plotlist = betaplots, nrow = 1)
```
